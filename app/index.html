<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programa Calculo</title>
    <link rel="stylesheet" href="index.css">
    <script src="https://www.geogebra.org/apps/deployggb.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="ggb-element"></div>
        <div class="container-func">
            <h2>Calculadora de Derivadas</h2>
            
            <p>Insira a função polinomial (por exemplo, 2x^2 - 3x + 4):</p>
            
            <div class="input-group">
                <label for="function">f(x) =</label>
                <input id="function" type="text">
                <button onclick="calculate()">Calcular Derivada</button>
            </div>
            
            <p id="output"></p>
        </div>
    </div>
</body>
</html>

<script>
 var params = {
            "appName": "graphing",
            "width": 800,
            "height": 600,
            "showToolBar": false,
            "showAlgebraInput": true,
            "showMenuBar": false,
        };
        var applet = new GGBApplet(params, true);
        window.addEventListener("load", function() {
            applet.inject('ggb-element', 'auto', 'preferHTML5');
        });
        // Função para centralizar o gráfico
                function centerGraph(x, y) {
            var ggb = applet.getAppletObject();
            var xOffset = 5; // Define um deslocamento padrão para a visualização
            var yOffset = 5;
            ggb.setCoordSystem(x - xOffset, x + xOffset, y - yOffset, y + yOffset);
        }

        // Função para adicionar a função e o ponto no GeoGebra
        function addFunctionAndPointToGeoGebra(funcao, ponto_a) {
            var ggb = applet.getAppletObject();
            ggb.evalCommand(`f(x) = ${funcao}`);
            var scope = { x: ponto_a };
            var fa = math.evaluate(funcao, scope);
            ggb.evalCommand(`P = (${ponto_a}, ${fa})`);
        }

        // Função para adicionar a reta tangente no GeoGebra
        function addTangentLineToGeoGebra(funcao, derivada, ponto_a) {
            var ggb = applet.getAppletObject();
            var scope = { x: ponto_a };
            var fpa = math.evaluate(derivada, scope);
            var fa = math.evaluate(funcao, scope);
            var retaTangente = `${fpa} * (x - ${ponto_a}) + ${fa}`;
            ggb.evalCommand(`y = ${fpa} * (x - ${ponto_a}) + ${fa}`);
        }
        function clearAll() {
            var ggb = applet.getAppletObject();
            ggb.reset();
        }

        function calculate() {
    clearAll();
    
    var funcao = document.getElementById("function").value; // Pegando a função do input
    funcao = funcao.replace(/\s/g, ''); // Removendo espaços da função
    var termos = funcao.split(/(?=[+-])/); // Separando os termos da função
    var derivada = ''; // Inicializando a derivada

    if (termos.length === 1 && !termos[0].includes('x')) {
        // Caso seja uma constante
        derivada = '0';
    } else {
        for (var i = 0; i < termos.length; i++) { // For rodando todos os termos escritos no input
            var term = termos[i]; // Pegando o termo atual

            if (term.includes('x')) { // Verificando se o termo atual possui o X
                var coeficiente = term.split('x')[0]; // Pegando o coeficiente do termo atual
                coeficiente = coeficiente === '+' || coeficiente === '' ? 1 : coeficiente === '-' ? -1 : parseFloat(coeficiente); // Trata coeficientes implícitos

                var expoente = parseFloat(term.split('^')[1] || '1'); // Pegando o expoente do termo atual

                var novoCoeficiente = coeficiente * expoente; // Calculando o novo coeficiente para derivada
                var novoExpoente = expoente - 1; // Calculando o novo expoente para derivada

                var sinal = novoCoeficiente >= 0 && derivada !== '' ? ' + ' : ''; // Adiciona o sinal de '+' se o coeficiente for positivo e não for o primeiro termo

                if (expoente < 0) {
                    var novoCoeficiente = coeficiente * expoente;
                    var novoExpoente = expoente - 1;
                    var sinal = novoCoeficiente >= 0 && derivada !== '' ? ' + ' : '';

                    if (novoExpoente === 1) {
                        derivada += sinal + novoCoeficiente + 'x';
                    } else if (novoExpoente !== 0) {
                        derivada += sinal + novoCoeficiente + 'x^' + novoExpoente;
                    } else {
                        derivada += sinal + novoCoeficiente;
                    }
                } else {
                    var novoCoeficiente = coeficiente * expoente;
                    var novoExpoente = expoente - 1;
                    var sinal = novoCoeficiente >= 0 && derivada !== '' ? ' + ' : '';

                    if (novoExpoente === 1) {
                        derivada += sinal + novoCoeficiente + 'x';
                    } else if (novoExpoente !== 0) {
                        derivada += sinal + novoCoeficiente + 'x^' + novoExpoente;
                    } else {
                        derivada += sinal + novoCoeficiente;
                    }
                }

            }
        }
    }

    document.getElementById("output").innerHTML = 'Resultado:<br>f\'(x) = ' + derivada; // Inserindo o resultado no HTML

    var calcularValorFuncional = confirm("Deseja calcular valor funcional?");
    if (calcularValorFuncional) {
        var ponto_a = parseFloat(prompt("Qual o valor de a?"));
        var scope = { x: ponto_a }; // Define o escopo para a substituição de variáveis

        try {
            var fa = math.evaluate(funcao, scope);
            var fpa = math.evaluate(derivada, scope);
            document.getElementById("output").innerHTML += '<br>f(a) = ' + fa;
            document.getElementById("output").innerHTML += '<br>f\'(a) = ' + fpa;
            document.getElementById("output").innerHTML += '<br>Ponto P(a, f(a)) = (' + ponto_a + ', ' + fa + ')';

            // Adiciona a função e o ponto ao GeoGebra
            addFunctionAndPointToGeoGebra(funcao, ponto_a);
        } catch (error) {
            alert("Erro ao calcular a função ou sua derivada: " + error.message);
        }
    }

    var calcularRetaTangente = confirm("Deseja calcular equacao da reta tangente ao gráfico de f no ponto P(a, f(a))?");
    if (calcularRetaTangente) {
        var a = parseFloat(prompt("Qual o valor de a?"));
        var scope = { x: a }; // Define o escopo para a substituição de variáveis

        try {
            var fa = math.evaluate(funcao, scope);
            var fpa = math.evaluate(derivada, scope);
            var b = fa - fpa * a;
    
            // Formatar a equação da reta tangente
            var retaTangente;
            if (b >= 0) {
                retaTangente = `y = ${fpa}x + ${b}`;
            } else {
                retaTangente = `y = ${fpa}x - ${Math.abs(b)}`;
            }

            document.getElementById("output").innerHTML += '<br>A equação da reta tangente ao gráfico de f no ponto P(' + a + ', ' + fa + ') é ' + retaTangente;

            addTangentLineToGeoGebra(funcao, derivada, a);
        } catch (error) {
            alert("Erro ao calcular a equação da reta tangente: " + error.message);
        }
    }
}


</script>